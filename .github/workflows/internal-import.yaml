name: Import Rules
on:
  pull_request:
    branches: [main]
jobs:
  check-imports:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed Go files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*.go
      - name: Check Imports
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          #!/usr/bin/env bash
          IFS=$'\n'
          PATTERN='"github.com/konveyor/tackle2-hub/internal/'
          found=false
          set -euo pipefail
          echo ""
          echo "RULE: import from internal/* not permitted outside of:"
          echo "  - cmd/*"
          echo "  - internal/*"
          echo ""
          for file in $CHANGED_FILES; do
              # allowed
              case "$file" in
                  internal/*|cmd/*)
                      continue
                      ;;
              esac
              if grep -qF "$PATTERN" "$file"; then
                  echo "::error file=$file::Forbidden import found."
                  grep --color=always -F "$PATTERN" "$file" || true
                  found=true
              fi
          done
          if [[ "$found" == true ]]; then
              echo
              echo "::error Rule violations detected."
              exit 1
          fi
          echo "âœ“ No rule violations detected."